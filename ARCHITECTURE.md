# Architecture Diagram - Optimized Python Background Removal

## Before (Problem)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Render/Vercel (512MB RAM)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Frontend         Backend            Python rembg        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Uploadâ”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Node.jsâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚rembg    â”‚ 300MB! â”‚
â”‚  â”‚photo â”‚ (3MB)  â”‚(150MB)â”‚         â”‚(300MB)  â”‚âš ï¸       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                       â”‚                  â”‚               â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                            â†“                             â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                      â”‚  Cloudinary  â”‚                   â”‚
â”‚                      â”‚   (upload)   â”‚                   â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                           â”‚
â”‚  Total RAM: 150 + 300 = 450MB âš ï¸ (getting close!)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## After (Solution) - NEW Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Vercel/Render (512MB RAM)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Frontend         Backend (Optimized)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚Uploadâ”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Node.js (80MB)  â”‚                   â”‚
â”‚  â”‚photo â”‚ (3MB)  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜                â”‚                              â”‚
â”‚                          â”‚ (fetch raw)                  â”‚
â”‚                          â–¼                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                   â”‚ Python rembg    â”‚                  â”‚
â”‚                   â”‚ (Optimized)     â”‚                  â”‚
â”‚                   â”‚ ~100MB max      â”‚âœ… Streaming      â”‚
â”‚                   â”‚ - Chunks: 256KB â”‚   Downsampled    â”‚
â”‚                   â”‚ - Size: 800x800 â”‚   GC cleanup     â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                          â”‚                              â”‚
â”‚                          â–¼                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                   â”‚  Cloudinary     â”‚                  â”‚
â”‚                   â”‚  (upload clean) â”‚                  â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                          â”‚                              â”‚
â”‚                          â–¼                              â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                   â”‚  Database       â”‚                  â”‚
â”‚                   â”‚  (save URL)     â”‚                  â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                           â”‚
â”‚  Total RAM: 80 + 100 = 180MB âœ… (plenty of headroom!)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Request Flow

```
1. UPLOAD PHOTO
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User clicks:    â”‚
   â”‚ "Clean Photo"   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Frontend sends  â”‚
   â”‚ rawPhotoUrl to  â”‚
   â”‚ /fetch-and-cleanâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
2. FETCH & CLEAN
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Backend fetches raw  â”‚
   â”‚ image from URL       â”‚
   â”‚ (~3MB downloaded)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
3. PYTHON OPTIMIZATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Python rembg processes:   â”‚
   â”‚ 1. Read 256KB chunks      â”‚
   â”‚ 2. Downscale 800x800      â”‚
   â”‚ 3. Remove background      â”‚
   â”‚ 4. Add blue background    â”‚
   â”‚ 5. Save as PNG            â”‚
   â”‚ (~100MB peak)             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
4. UPLOAD TO CLOUDINARY
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Upload clean PNG     â”‚
   â”‚ to Cloudinary        â”‚
   â”‚ (secure_url)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
5. SAVE TO DATABASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Save clean URL to    â”‚
   â”‚ idCard.cleanPhotoUrl â”‚
   â”‚ for ID Card PDF      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
âœ… DONE! Use in ID Card PDF
```

## Memory Timeline During Processing

```
Timeline (ms) â”‚ Node.js â”‚ Python â”‚ Total â”‚ Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Start: 0      â”‚ 80 MB   â”‚ 0 MB   â”‚ 80MB  â”‚ Idle
Fetch: 500    â”‚ 80 MB   â”‚ 0 MB   â”‚ 80mb  â”‚ Downloading image
Start Py: 600 â”‚ 80 MB   â”‚ 10 MB  â”‚ 90mb  â”‚ Python starting
Process: 2000 â”‚ 80 MB   â”‚ 100 MB â”‚ 180MB â”‚ Peak! âš ï¸ (still ok)
Cleanup: 2500 â”‚ 80 MB   â”‚ 5 MB   â”‚ 85mb  â”‚ Python done
Upload: 3000  â”‚ 90 MB   â”‚ 0 MB   â”‚ 90mb  â”‚ Uploading to CDN
Save: 3100    â”‚ 80 MB   â”‚ 0 MB   â”‚ 80mb  â”‚ Complete âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Max RAM Used: 180MB (vs 500MB original, vs 512MB limit) âœ…
```

## Comparison: Processing Methods

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Background Removal Methods                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Method           â”‚ Cost         â”‚ Memory        â”‚ Quality    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Uploadcare API   â”‚ $$$ Premium  â”‚ 0 MB (CDN)    â”‚ â­â­â­â­â­ â”‚
â”‚ remove.bg API    â”‚ Free (50/mo) â”‚ 0 MB (CDN)    â”‚ â­â­â­â­â­ â”‚
â”‚ Python rembg     â”‚ FREE âœ…      â”‚ 300 MB âš ï¸     â”‚ â­â­â­â­   â”‚
â”‚ Python opt'd     â”‚ FREE âœ…      â”‚ 100 MB âœ…     â”‚ â­â­â­â­   â”‚
â”‚ Cloudinary fx    â”‚ Free tier    â”‚ 0 MB          â”‚ â­â­â­     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

YOUR CHOICE: Python Optimized âœ…
- Free: No API quota limits
- Works on 512MB RAM: With optimization
- Quality: Matches original rembg
```

## File Dependencies

```
fibuca-backend/
â”‚
â”œâ”€â”€ index.js (MAIN BACKEND)
â”‚   â””â”€â”€ requires removeBackgroundBuffer
â”‚       â””â”€â”€ from py-tools/utils/runPython.js
â”‚           â””â”€â”€ calls remove_bg_buffer_optimized.py
â”‚               â””â”€â”€ uses rembg library (Python)
â”‚
â”œâ”€â”€ py-tools/utils/runPython.js
â”‚   â””â”€â”€ spawns Python process
â”‚       â””â”€â”€ uses remove_bg_buffer_optimized.py
â”‚
â”œâ”€â”€ py-tools/remove_bg_buffer_optimized.py
â”‚   â”œâ”€â”€ reads stdin (256KB chunks)
â”‚   â”œâ”€â”€ uses PIL for image ops
â”‚   â””â”€â”€ uses rembg for bg removal
â”‚
â”œâ”€â”€ vercel.json
â”‚   â””â”€â”€ config: 512MB memory limit
â”‚
â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ express, multer, axios
â”‚   â”œâ”€â”€ cloudinary, @prisma/client
â”‚   â””â”€â”€ streamifier
â”‚
â””â”€â”€ .env
    â”œâ”€â”€ DATABASE_URL
    â”œâ”€â”€ CLOUDINARY_*
    â””â”€â”€ JWT_SECRET
```

## Deployment Status

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         DEPLOYMENT READINESS CHECK              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ âœ… Backend code optimized                      â•‘
â•‘ âœ… Python script optimized                     â•‘
â•‘ âœ… Memory footprint reduced                    â•‘
â•‘ âœ… Error handling implemented                  â•‘
â•‘ âœ… Fallback for Python failures                â•‘
â•‘ â³ Python environment setup (do this)          â•‘
â•‘ â³ Test endpoints (do this)                    â•‘
â•‘ â³ Deploy to Vercel (do this)                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Next: See PYTHON-SETUP.md for instructions
```

---

## Key Points

ğŸ¯ **Optimization Techniques**:
- Streaming/chunked reading (not loading entire file)
- Image downsampling (800x800 max)
- Format conversion (RGBA â†’ RGB)
- Garbage collection (aggressive cleanup)

ğŸ“Š **Results**:
- Before: 450MB â†’ Over limit!
- After: 180MB â†’ Safe with headroom!

âœ¨ **Benefits**:
- Free (no API costs)
- Works on 512MB limit
- Same photo quality
- Graceful error handling
